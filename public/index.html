<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analizador de licitaciones</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header>
      <div>
        <h1>Chatbot para licitaciones</h1>
        <p>
          Identifica requerimientos funcionales, requerimientos no funcionales y
          ambigüedades de pliegos de software usando modelos de OpenRouter.
        </p>
      </div>
    </header>

    <main>
      <section class="panel">
        <div class="field">
          <label for="model">Modelo</label>
          <select id="model">
            <option value="mistralai/mistral-7b-instruct:free">mistralai/mistral-7b-instruct:free</option>
            <option value="google/gemma-2-9b-it:free">google/gemma-2-9b-it:free</option>
          </select>
        </div>

        <div class="field">
          <label for="prompt">Prompt</label>
          <textarea
            id="prompt"
            rows="8"
            placeholder="Pega aquí el texto de la licitación o describe qué necesitas revisar"
          >Analiza el siguiente pliego y lista:
- Requerimientos funcionales
- Requerimientos no funcionales
- Ambigüedades o información incompleta que deba aclararse</textarea>
        </div>

        <div class="field">
          <label for="file">Adjuntar archivo (texto, PDF convertido a texto, etc.)</label>
          <input type="file" id="file" accept=".txt,.md,.pdf,.doc,.docx" />
          <p class="hint">
            El contenido del archivo se incluirá en el prompt. Para mejores
            resultados, sube archivos de texto plano.
          </p>
        </div>

        <button id="send">Enviar al chatbot</button>
        <p id="status" class="hint"></p>
      </section>

      <section class="panel">
        <h2>Respuesta</h2>
        <pre id="reply" class="reply">Esperando consulta...</pre>
      </section>
    </main>

    <script>
      const fileInput = document.getElementById('file');
      const promptInput = document.getElementById('prompt');
      const modelSelect = document.getElementById('model');
      const statusEl = document.getElementById('status');
      const replyEl = document.getElementById('reply');
      const sendBtn = document.getElementById('send');

      function setStatus(message, isError = false) {
        statusEl.textContent = message;
        statusEl.classList.toggle('error', isError);
      }

      async function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(reader.error);
          reader.readAsText(file);
        });
      }

      async function handleSend() {
        const prompt = promptInput.value.trim();
        const model = modelSelect.value;

        if (!prompt) {
          setStatus('El prompt no puede estar vacío.', true);
          return;
        }

        let fileContent = '';
        const file = fileInput.files?.[0];
        if (file) {
          try {
            fileContent = await readFileAsText(file);
          } catch (err) {
            setStatus('No se pudo leer el archivo: ' + err.message, true);
            return;
          }
        }

        setStatus('Enviando consulta al modelo...');
        sendBtn.disabled = true;
        replyEl.textContent = 'Consultando...';

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model, prompt, fileContent }),
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'Error desconocido');
          }

          replyEl.textContent = data.reply || 'Sin respuesta';
          setStatus('Consulta completada');
        } catch (error) {
          replyEl.textContent = '—';
          setStatus(error.message, true);
        } finally {
          sendBtn.disabled = false;
        }
      }

      sendBtn.addEventListener('click', handleSend);
    </script>
  </body>
</html>
